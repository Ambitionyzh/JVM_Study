#### æ–¹æ³•è°ƒç”¨

```java
public class Demo3_9 {
    public Demo3_9() { }

    private void test1() { }

    private final void test2() { }

    public void test3() { }

    public static void test4() { }

    @Override
    public String toString() {
        return super.toString();
    }

    public static void main(String[] args) {
        Demo3_9 d = new Demo3_9();
        d.test1();
        d.test2();
        d.test3();
        d.test4();
        Demo3_9.test4();
        d.toString();
    }

}
```

å­—èŠ‚ç 

![image-20240309165534885](ç±»åŠ è½½ä¸å­—èŠ‚ç æŠ€æœ¯.assets/image-20240309165534885.png)

* new æ˜¯åˆ›å»ºã€å¯¹è±¡ã€‘ï¼Œç»™å¯¹è±¡åˆ†é…å †å†…å­˜ï¼Œæ‰§è¡ŒæˆåŠŸä¼šå°†ã€å¯¹è±¡å¼•ç”¨ã€‘å‹å…¥æ“ä½œæ•°æ ˆ
*  dup æ˜¯å¤åˆ¶æ“ä½œæ•°æ ˆæ ˆé¡¶çš„å†…å®¹ï¼Œæœ¬ä¾‹å³ä¸ºã€å¯¹è±¡å¼•ç”¨ã€‘ï¼Œä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä»½å¼•ç”¨å‘¢ï¼Œä¸€ä¸ªæ˜¯è¦é… åˆ invokespecial è°ƒç”¨è¯¥å¯¹è±¡çš„æ„é€ æ–¹æ³• "":()V ï¼ˆä¼šæ¶ˆè€—æ‰æ ˆé¡¶ä¸€ä¸ªå¼•ç”¨ï¼‰ï¼Œå¦ä¸€ä¸ªè¦ é…åˆ astore_1 èµ‹å€¼ç»™å±€éƒ¨å˜é‡
* æœ€ç»ˆæ–¹æ³•ï¼ˆfinalï¼‰ï¼Œç§æœ‰æ–¹æ³•ï¼ˆprivateï¼‰ï¼Œæ„é€ æ–¹æ³•éƒ½æ˜¯ç”± invokespecial æŒ‡ä»¤æ¥è°ƒç”¨ï¼Œå±äºé™ æ€ç»‘å®š
* æ™®é€šæˆå‘˜æ–¹æ³•æ˜¯ç”± invokevirtual è°ƒç”¨ï¼Œå±äºåŠ¨æ€ç»‘å®šï¼Œå³æ”¯æŒå¤šæ€ã€‚éœ€è¦æŸ¥æ‰¾å¤šæ¬¡æ‰èƒ½ç¡®å®šæ–¹æ³•çš„å…¥å£åœ°å€ã€‚
* è¿˜æœ‰ä¸€ä¸ªæ‰§è¡Œ invokespecial çš„æƒ…å†µæ˜¯é€šè¿‡ super è°ƒç”¨çˆ¶ç±»æ–¹æ³•
* æˆå‘˜æ–¹æ³•ä¸é™æ€æ–¹æ³•è°ƒç”¨çš„å¦ä¸€ä¸ªåŒºåˆ«æ˜¯ï¼Œæ‰§è¡Œæ–¹æ³•å‰æ˜¯å¦éœ€è¦ã€å¯¹è±¡å¼•ç”¨ã€‘ æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯ d.test4(); æ˜¯é€šè¿‡ã€å¯¹è±¡å¼•ç”¨ã€‘è°ƒç”¨ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°åœ¨è°ƒç”¨ invokestatic ä¹‹å‰æ‰§è¡Œäº† pop æŒ‡ä»¤ï¼ŒæŠŠã€å¯¹è±¡å¼•ç”¨ã€‘ä»æ“ä½œæ•°æ ˆå¼¹æ‰äº†ğŸ˜‚ ï¼ˆé™æ€æ–¹æ³•çš„è°ƒç”¨ä¸éœ€è¦å¯¹è±¡ï¼‰è¿˜æœ‰ä¸€ä¸ªæ‰§è¡Œ invokespecial çš„æƒ…å†µæ˜¯é€šè¿‡ super è°ƒç”¨çˆ¶ç±»æ–¹æ³•

#### å¤šæ€çš„åŸç†

```java
public class Demo3_10 {

    public static void test(Animal animal) {
        animal.eat();
        System.out.println(animal.toString());
    }

    public static void main(String[] args) throws IOException {
        test(new Cat());
        test(new Dog());
        System.in.read();
    }
}

abstract class Animal {
    public abstract void eat();

    @Override
    public String toString() {
        return "æˆ‘æ˜¯" + this.getClass().getSimpleName();
    }
}

class Dog extends Animal {

    @Override
    public void eat() {
        System.out.println("å•ƒéª¨å¤´");
    }
}

class Cat extends Animal {

    @Override
    public void eat() {
        System.out.println("åƒé±¼");
    }
}
```

1ï¼‰è¿è¡Œä»£ç  åœåœ¨ System.in.read() æ–¹æ³•ä¸Šï¼Œè¿™æ—¶è¿è¡Œ jps è·å–è¿›ç¨‹ id   
2ï¼‰è¿è¡Œ HSDB å·¥å…· è¿›å…¥ JDK å®‰è£…ç›®å½•ï¼Œæ‰§è¡Œ

```shell
java -cp ./lib/sa-jdi.jar sun.jvm.hotspot.HSDB
```

è¿›å…¥å›¾å½¢ç•Œé¢ attach è¿›ç¨‹ id

3ï¼‰æŸ¥æ‰¾æŸä¸ªå¯¹è±¡ æ‰“å¼€ Tools -> Find Object By Query è¾“å…¥ select d from cn.itcast.jvm.t3.bytecode.Dog d ç‚¹å‡» Execute æ‰§è¡Œã€‚æ‰¾åˆ°è¯¥å¯¹è±¡çš„å†…å­˜åœ°å€ã€‚

![image-20240310095720724](ç±»åŠ è½½ä¸å­—èŠ‚ç æŠ€æœ¯.assets/image-20240310095720724.png)

4ï¼‰æŸ¥çœ‹å¯¹è±¡å†…å­˜ç»“æ„

ç‚¹å‡»è¶…é“¾æ¥å¯ä»¥çœ‹åˆ°å¯¹è±¡çš„å†…å­˜ç»“æ„ï¼Œæ­¤å¯¹è±¡æ²¡æœ‰ä»»ä½•å±æ€§ï¼Œå› æ­¤åªæœ‰å¯¹è±¡å¤´çš„ 16 å­—èŠ‚ï¼Œå‰ 8 å­—èŠ‚æ˜¯ MarkWordï¼Œå 8 å­—èŠ‚å°±æ˜¯å¯¹è±¡çš„ Class æŒ‡é’ˆ ä½†ç›®å‰çœ‹ä¸åˆ°å®ƒçš„å®é™…åœ°å€

![image-20240310095645879](ç±»åŠ è½½ä¸å­—èŠ‚ç æŠ€æœ¯.assets/image-20240310095645879.png)

5ï¼‰æŸ¥çœ‹å¯¹è±¡ Class çš„å†…å­˜åœ°å€

å¯ä»¥é€šè¿‡ Windows -> Console è¿›å…¥å‘½ä»¤è¡Œæ¨¡å¼ï¼Œæ‰§è¡Œ

```
mem 0x00000001299b4978 2
```

mem æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œå‚æ•° 1 æ˜¯å¯¹è±¡åœ°å€ï¼Œå‚æ•° 2 æ˜¯æŸ¥çœ‹ 2 è¡Œï¼ˆå³ 16 å­—èŠ‚ï¼‰ ç»“æœä¸­ç¬¬äºŒè¡Œ 0x000000001b7d4028 å³ä¸º Class çš„å†…å­˜åœ°å€

![image-20240310095951902](ç±»åŠ è½½ä¸å­—èŠ‚ç æŠ€æœ¯.assets/image-20240310095951902.png)

6ï¼‰æŸ¥çœ‹ç±»çš„ vtable

æ–¹æ³•1ï¼šAlt+R è¿›å…¥ Inspector å·¥å…·ï¼Œè¾“å…¥åˆšæ‰çš„ Class å†…å­˜åœ°å€ï¼Œçœ‹åˆ°å¦‚ä¸‹ç•Œé¢

![image-20240310100543720](ç±»åŠ è½½ä¸å­—èŠ‚ç æŠ€æœ¯.assets/image-20240310100543720.png)

æˆ–è€… Tools -> Class Browser è¾“å…¥ Dog æŸ¥æ‰¾ï¼Œå¯ä»¥å¾—åˆ°ç›¸åŒçš„ç»“æœ

![image-20240310100102580](ç±»åŠ è½½ä¸å­—èŠ‚ç æŠ€æœ¯.assets/image-20240310100102580.png)

æ— è®ºé€šè¿‡å“ªç§æ–¹æ³•ï¼Œéƒ½å¯ä»¥æ‰¾åˆ° Dog Class çš„ vtable é•¿åº¦ä¸º 6ï¼Œæ„æ€å°±æ˜¯ Dog ç±»æœ‰ 6 ä¸ªè™šæ–¹æ³•ï¼ˆå¤šæ€ ç›¸å…³çš„ï¼Œfinalï¼Œstatic ä¸ä¼šåˆ—å…¥ï¼‰ é‚£ä¹ˆè¿™ 6 ä¸ªæ–¹æ³•éƒ½æ˜¯è°å‘¢ï¼Ÿä» Class çš„èµ·å§‹åœ°å€å¼€å§‹ç®—ï¼Œåç§» 0x1b8 å°±æ˜¯ vtable çš„èµ·å§‹åœ°å€ï¼Œè¿›è¡Œè®¡ ç®—å¾—åˆ°

```
0x000000001b7d4028 
				1b8 + 
--------------------- 
0x000000001b7d41e0
```

é€šè¿‡ Windows -> Console è¿›å…¥å‘½ä»¤è¡Œæ¨¡å¼ï¼Œæ‰§è¡Œ

![image-20240310100651643](ç±»åŠ è½½ä¸å­—èŠ‚ç æŠ€æœ¯.assets/image-20240310100651643.png)

å°±å¾—åˆ°äº† 6 ä¸ªè™šæ–¹æ³•çš„å…¥å£åœ°å€

```
Dog - public void eat() @0x000000001b7d3fa8 
Animal - public java.lang.String toString() @0x000000001b7d35e8; 
Object - protected void finalize() @0x000000001b3d1b10; 
Object - public boolean equals(java.lang.Object) @0x000000001b3d15e8; 
Object - public native int hashCode() @0x000000001b3d1540; 
Object - protected native java.lang.Object clone() @0x000000001b3d1678;
```

å¯¹å·å…¥åº§ï¼Œå‘ç° eat() æ–¹æ³•æ˜¯ Dog ç±»è‡ªå·±çš„ toString() æ–¹æ³•æ˜¯ç»§æ‰¿ String ç±»çš„ finalize() ï¼Œequals()ï¼ŒhashCode()ï¼Œclone() éƒ½æ˜¯ç»§æ‰¿ Object ç±»çš„

8ï¼‰å°ç»“ å½“æ‰§è¡Œ invokevirtual æŒ‡ä»¤æ—¶ï¼Œ

1. å…ˆé€šè¿‡æ ˆå¸§ä¸­çš„å¯¹è±¡å¼•ç”¨æ‰¾åˆ°å¯¹è±¡ 
2. åˆ†æå¯¹è±¡å¤´ï¼Œæ‰¾åˆ°å¯¹è±¡çš„å®é™… Class 
3.  Class ç»“æ„ä¸­æœ‰ vtableï¼Œå®ƒåœ¨ç±»åŠ è½½çš„é“¾æ¥é˜¶æ®µå°±å·²ç»æ ¹æ®æ–¹æ³•çš„é‡å†™è§„åˆ™ç”Ÿæˆå¥½äº† 
4. æŸ¥è¡¨å¾—åˆ°æ–¹æ³•çš„å…·ä½“åœ°å€
5.  æ‰§è¡Œæ–¹æ³•çš„å­—èŠ‚ç 